<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Flow Agent Dashboard - MessagePedia P2P</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #4a9eff;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #4a9eff;
        }
        
        .status-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
        }
        
        .panel h2 {
            color: #4a9eff;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .agent {
            background: #333;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #4a9eff;
        }
        
        .agent.active {
            border-left-color: #00ff88;
        }
        
        .agent.busy {
            border-left-color: #ff9500;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .agent-name {
            font-weight: bold;
            color: #e0e0e0;
        }
        
        .agent-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            text-transform: uppercase;
        }
        
        .agent-status.active {
            background: #00ff88;
            color: #000;
        }
        
        .agent-status.busy {
            background: #ff9500;
            color: #000;
        }
        
        .agent-status.idle {
            background: #666;
            color: #fff;
        }
        
        .agent-task {
            font-size: 14px;
            color: #bbb;
            margin-bottom: 8px;
        }
        
        .agent-capabilities {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .capability {
            background: #444;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            color: #ccc;
        }
        
        .task {
            background: #333;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #666;
        }
        
        .task.high {
            border-left-color: #ff4757;
        }
        
        .task.medium {
            border-left-color: #ff9500;
        }
        
        .task.low {
            border-left-color: #4a9eff;
        }
        
        .task.completed {
            border-left-color: #00ff88;
            opacity: 0.7;
        }
        
        .task.pending {
            border-left-color: #ff9500;
        }
        
        .task.backlog {
            border-left-color: #666;
            opacity: 0.8;
        }
        
        .task-status-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            text-transform: uppercase;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status.in_progress {
            background: #ff4757;
            color: white;
        }
        
        .status.pending {
            background: #ff9500;
            color: white;
        }
        
        .status.backlog {
            background: #666;
            color: white;
        }
        
        .github-link {
            color: #4a9eff;
            text-decoration: none;
            font-size: 11px;
            margin-left: 8px;
        }
        
        .github-link:hover {
            text-decoration: underline;
        }
        
        .task-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .task-id {
            font-family: monospace;
            font-size: 12px;
            color: #999;
        }
        
        .task-priority {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 8px;
            text-transform: uppercase;
        }
        
        .priority.high {
            background: #ff4757;
            color: white;
        }
        
        .priority.medium {
            background: #ff9500;
            color: white;
        }
        
        .priority.low {
            background: #4a9eff;
            color: white;
        }
        
        .task-description {
            font-size: 14px;
            color: #ddd;
            line-height: 1.4;
        }
        
        .sparc-progress {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .sparc-phase {
            flex: 1;
            text-align: center;
            padding: 8px;
            background: #444;
            margin: 0 2px;
            border-radius: 4px;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .sparc-phase.completed {
            background: #00ff88;
            color: #000;
        }
        
        .sparc-phase.current {
            background: #ff9500;
            color: #000;
            animation: pulse 2s infinite;
        }
        
        .activity-log {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            font-family: monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .log-entry:hover {
            background: #333;
            padding: 8px;
            transform: translateX(5px);
        }
        
        .log-timestamp {
            color: #666;
            margin-right: 10px;
        }
        
        .log-agent {
            color: #4a9eff;
            margin-right: 10px;
        }
        
        .log-message {
            color: #e0e0e0;
        }
        
        .refresh-controls {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .refresh-btn {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
        }
        
        .refresh-btn:hover {
            background: #357abd;
        }
        
        .refresh-btn.recording {
            background: #ff4757;
        }
        
        .refresh-btn.recording:hover {
            background: #c44569;
        }
        
        .refresh-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .session-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 10px 0;
            gap: 10px;
        }
        
        .playback-slider {
            flex: 1;
            max-width: 300px;
            margin: 0 15px;
        }
        
        .time-display {
            color: #4a9eff;
            font-family: monospace;
            font-size: 14px;
            min-width: 120px;
        }
        
        .session-info {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #ff9500;
        }
        
        .session-info.recording {
            border-left-color: #ff4757;
            animation: pulse 2s infinite;
        }
        
        .session-info.replay {
            border-left-color: #4a9eff;
        }
        
        .auto-refresh {
            color: #00ff88;
            margin-left: 10px;
        }
        
        /* Detail Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .modal-content {
            background-color: #2a2a2a;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 900px;
            max-height: 80%;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #4a9eff;
        }
        
        .detail-header {
            border-bottom: 2px solid #4a9eff;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .detail-title {
            color: #4a9eff;
            font-size: 24px;
            margin: 0;
        }
        
        .detail-subtitle {
            color: #999;
            font-size: 14px;
            margin: 5px 0 0 0;
        }
        
        .detail-section {
            margin-bottom: 25px;
        }
        
        .detail-section h3 {
            color: #4a9eff;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .progress-bar {
            background: #444;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #4a9eff, #00ff88);
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 12px;
            color: #ccc;
        }
        
        .code-block {
            background: #1e1e1e;
            border-radius: 5px;
            padding: 15px;
            font-family: monospace;
            color: #e0e0e0;
            border-left: 4px solid #4a9eff;
            margin: 10px 0;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .metric-card {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #4a9eff;
            display: block;
        }
        
        .metric-label {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
        }
        
        .task.clickable:hover {
            border-left-width: 8px;
        }
        
        .sparc-phase.clickable:hover {
            transform: scale(1.05);
        }
        
        .timeline {
            margin: 20px 0;
        }
        
        .timeline-item {
            display: flex;
            margin-bottom: 15px;
            padding: 10px;
            background: #333;
            border-radius: 5px;
            border-left: 4px solid #4a9eff;
        }
        
        .timeline-time {
            color: #666;
            font-size: 12px;
            margin-right: 15px;
            min-width: 60px;
        }
        
        .timeline-content {
            flex: 1;
        }
        
        .timeline-title {
            color: #e0e0e0;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .timeline-description {
            color: #bbb;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ü§ñ Claude Flow Agent Dashboard</h1>
            <p>Real-time monitoring of autonomous P2P development agents</p>
        </div>
        
        <div class="status-bar">
            <div class="status-item">
                <div class="status-value" id="agent-count">0</div>
                <div class="status-label">Active Agents</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="task-count">0</div>
                <div class="status-label">Tasks</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="github-issues">6</div>
                <div class="status-label">GitHub Issues</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="sparc-phase">Pseudocode</div>
                <div class="status-label">Current SPARC Phase</div>
            </div>
        </div>
        
        <div class="refresh-controls">
            <button class="refresh-btn" onclick="refreshDashboard()">üîÑ Refresh Now</button>
            <button class="refresh-btn" onclick="toggleAutoRefresh()">‚è±Ô∏è Auto Refresh</button>
            <button class="refresh-btn" onclick="showAgentLogs()">üìã View Logs</button>
            <button class="refresh-btn" onclick="exportLogs()">üíæ Export Logs</button>
            <span class="auto-refresh" id="auto-status">OFF</span>
        </div>
        
        <div class="main-grid">
            <div class="panel">
                <h2>ü§ñ Active Agents</h2>
                <div id="agents-container">
                    <!-- Agents will be populated here -->
                </div>
            </div>
            
            <div class="panel">
                <h2>üìã Task Queue</h2>
                <div id="tasks-container">
                    <!-- Tasks will be populated here -->
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2>üìà SPARC Progress - WebRTC Implementation</h2>
            <div class="sparc-progress">
                <div class="sparc-phase completed clickable" onclick="showSPARCDetail('specification')">S - Specification</div>
                <div class="sparc-phase current clickable" onclick="showSPARCDetail('pseudocode')">P - Pseudocode</div>
                <div class="sparc-phase clickable" onclick="showSPARCDetail('architecture')">A - Architecture</div>
                <div class="sparc-phase clickable" onclick="showSPARCDetail('refinement')">R - Refinement</div>
                <div class="sparc-phase clickable" onclick="showSPARCDetail('completion')">C - Completion</div>
            </div>
        </div>
        
        <div class="panel">
            <h2>üìù Activity Log</h2>
            <div class="activity-log" id="activity-log">
                <!-- Activity will be populated here -->
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDetailModal()">&times;</span>
            <div id="modal-content">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        
        // Real-time Claude Flow Integration
        let claudeFlowAPI = {
            swarmId: 'swarm_1754887071304_uwsrpe9fj',
            lastLogIndex: 0,
            logHistory: [],
            agentStates: new Map(),
            taskStates: new Map()
        };

        // Real-time data containers
        let currentAgents = [];
        let currentTasks = [];
        let activityLog = [];

        // Fetch real agent status from Claude Flow
        async function fetchSwarmStatus() {
            try {
                // In a real implementation, this would call the Claude Code MCP tools
                // For now, simulate the API structure with real data
                console.log('üì° Fetching swarm status from Claude Flow...');
                
                // This would be: const response = await window.claudeCode.mcpCall('claude-flow', 'swarm_status', {});
                const swarmStatus = {
                    success: true,
                    swarmId: claudeFlowAPI.swarmId,
                    agentCount: 3,
                    activeAgents: 2,
                    taskCount: 1,
                    pendingTasks: 1
                };
                
                return swarmStatus;
            } catch (error) {
                console.error('‚ùå Failed to fetch swarm status:', error);
                return null;
            }
        }

        // Fetch real agent list and states
        async function fetchAgentList() {
            try {
                console.log('üì° Fetching agent list from Claude Flow...');
                
                // This would be: const response = await window.claudeCode.mcpCall('claude-flow', 'agent_list', {});
                const agents = [
                    {
                        id: 'agent_1754887075140_1vb3h7',
                        name: 'SPARC-WebRTC-Architect', 
                        type: 'architect',
                        status: 'busy',
                        currentTask: 'Generating WebRTC pseudocode from GitHub Issue #2',
                        capabilities: ['webrtc', 'p2p-networking', 'architecture-design', 'sparc-methodology'],
                        metrics: {
                            tasksCompleted: 2,
                            successRate: 100,
                            avgResponseTime: '1.8s',
                            activeTime: '8min'
                        }
                    },
                    {
                        id: 'agent_1754887078049_ubj1bi',
                        name: 'P2P-Implementation-Specialist',
                        type: 'coder', 
                        status: 'active',
                        currentTask: 'Standing by for architecture completion',
                        capabilities: ['javascript', 'node.js', 'electron', 'webrtc-datachannel'],
                        metrics: {
                            tasksCompleted: 0,
                            successRate: 0,
                            avgResponseTime: '0s',
                            activeTime: '0min'
                        }
                    },
                    {
                        id: 'agent_1754887081162_7qj6iw',
                        name: 'P2P-Quality-Assurance',
                        type: 'tester',
                        status: 'idle',
                        currentTask: 'Waiting for implementation to test',
                        capabilities: ['jest-testing', 'integration-testing', 'p2p-network-testing'],
                        metrics: {
                            tasksCompleted: 0,
                            successRate: 0,
                            avgResponseTime: '0s', 
                            activeTime: '0min'
                        }
                    },
                    {
                        id: 'agent_1754889019375_fxbsfk',
                        name: 'Encryption-Security-Specialist',
                        type: 'specialist',
                        status: 'busy',
                        currentTask: 'Analyzing GitHub Issue #4 encryption requirements',
                        capabilities: ['cryptography', 'rsa-ecc', 'aes-encryption', 'key-exchange', 'security-protocols'],
                        metrics: {
                            tasksCompleted: 0,
                            successRate: 0,
                            avgResponseTime: '0s',
                            activeTime: '2min'
                        }
                    },
                    {
                        id: 'agent_1754889023000_zzg0m5',
                        name: 'Crypto-Implementation-Engineer',
                        type: 'coder',
                        status: 'busy',
                        currentTask: 'Preparing encryption pseudocode for JavaScript implementation',
                        capabilities: ['javascript', 'web-crypto-api', 'node-crypto', 'key-management', 'secure-storage'],
                        metrics: {
                            tasksCompleted: 0,
                            successRate: 0,
                            avgResponseTime: '0s',
                            activeTime: '1min'
                        }
                    },
                    {
                        id: 'agent_1754889026910_bpsgil',
                        name: 'Security-Testing-Validator',
                        type: 'tester',
                        status: 'active',
                        currentTask: 'Designing security test framework for encryption validation',
                        capabilities: ['security-testing', 'penetration-testing', 'crypto-validation', 'vulnerability-assessment'],
                        metrics: {
                            tasksCompleted: 0,
                            successRate: 0,
                            avgResponseTime: '0s',
                            activeTime: '0min'
                        }
                    }
                ];
                
                return agents;
            } catch (error) {
                console.error('‚ùå Failed to fetch agent list:', error);
                return [];
            }
        }

        // Fetch real task status and progress
        async function fetchTaskStatus() {
            try {
                console.log('üì° Fetching task status from Claude Flow...');
                
                // This would be: const response = await window.claudeCode.mcpCall('claude-flow', 'task_status', {});
                const tasks = [
                    {
                        id: 'task_1754887085088_o9fs6t7lc',
                        description: 'GitHub Issue #2: WebRTC P2P Connection Implementation',
                        priority: 'high',
                        status: 'in_progress',
                        assignedAgent: 'SPARC-WebRTC-Architect',
                        progress: {
                            phase: 'Pseudocode',
                            completion: 67,
                            nextPhase: 'Architecture'
                        },
                        githubIssue: '#2'
                    },
                    {
                        id: 'task_1754887090234_m9dk2s',
                        description: 'GitHub Issue #3: Message Synchronization Protocol',
                        priority: 'medium',
                        status: 'pending',
                        assignedAgent: 'P2P-Implementation-Specialist',
                        progress: {
                            phase: 'Specification',
                            completion: 100,
                            nextPhase: 'Pseudocode'
                        },
                        githubIssue: '#3'
                    },
                    {
                        id: 'task_1754889032313_koisxt4ph',
                        description: 'GitHub Issue #4: End-to-End Encryption Implementation',
                        priority: 'medium',
                        status: 'in_progress',
                        assignedAgent: 'Encryption Team (3 agents)',
                        progress: {
                            phase: 'Pseudocode', 
                            completion: 15,
                            nextPhase: 'Architecture'
                        },
                        githubIssue: '#4'
                    },
                    {
                        id: 'task_1754887100912_p7xy4z',
                        description: 'GitHub Issue #5: Mobile App Development',
                        priority: 'low',
                        status: 'pending',
                        assignedAgent: 'Unassigned',
                        progress: {
                            phase: 'Specification',
                            completion: 45,
                            nextPhase: 'Pseudocode'
                        },
                        githubIssue: '#5'
                    },
                    {
                        id: 'task_1754887105345_r6wn8m',
                        description: 'GitHub Issue #6: Advanced UI Features',
                        priority: 'low', 
                        status: 'pending',
                        assignedAgent: 'Unassigned',
                        progress: {
                            phase: 'Specification',
                            completion: 30,
                            nextPhase: 'Pseudocode'
                        },
                        githubIssue: '#6'
                    },
                    {
                        id: 'task_1754887110789_t4bc9q',
                        description: 'GitHub Issue #1: Complete Documentation',
                        priority: 'low',
                        status: 'backlog',
                        assignedAgent: 'Unassigned',
                        progress: {
                            phase: 'Specification',
                            completion: 10,
                            nextPhase: 'Pseudocode'
                        },
                        githubIssue: '#1'
                    }
                ];
                
                return tasks;
            } catch (error) {
                console.error('‚ùå Failed to fetch task status:', error);
                return [];
            }
        }

        // Fetch real agent activity logs
        async function fetchAgentLogs() {
            try {
                console.log('üì° Fetching agent activity logs...');
                
                // This would fetch real agent-to-agent communications and model interactions
                // Enhanced with full context data for detailed views
                const encryptionLogs = [
                    {
                        id: `log_${Date.now()}_enc1`,
                        timestamp: new Date().toLocaleTimeString().slice(0, 8),
                        agent: 'Encryption-Security-Specialist',
                        type: 'model_interaction',
                        message: 'Analyzing RSA/ECC key generation requirements for Issue #4',
                        details: {
                            prompt: 'Design secure key pair generation strategy for P2P messaging with forward secrecy',
                            response: `// Key Generation Strategy\nclass P2PKeyManager {\n    async generateKeyPair() {\n        // Use ECDH P-256 for key exchange\n        const keyPair = await crypto.subtle.generateKey(\n            { name: "ECDH", namedCurve: "P-256" },\n            true, ["deriveKey"]\n        )\n        \n        // Generate RSA keys for message signing\n        const signingKeys = await crypto.subtle.generateKey(\n            { name: "RSA-PSS", modulusLength: 2048 },\n            true, ["sign", "verify"]\n        )\n        \n        return { keyPair, signingKeys }\n    }\n}`,
                            tokens: { input: 89, output: 234 },
                            duration: '1.9s',
                            confidence: 0.89,
                            githubIssue: '#4'
                        }
                    },
                    {
                        id: `log_${Date.now()}_enc2`,
                        timestamp: new Date().toLocaleTimeString().slice(0, 8),
                        agent: 'Crypto-Implementation-Engineer',
                        type: 'coordination',
                        message: 'Coordinating with Security Specialist on Web Crypto API implementation',
                        details: {
                            waitingFor: 'Encryption-Security-Specialist',
                            dependency: 'Key generation strategy completion',
                            readinessLevel: 'Ready to implement',
                            capabilities: ['javascript', 'web-crypto-api', 'node-crypto', 'key-management'],
                            estimatedStart: 'When crypto protocols are defined'
                        }
                    }
                ];
                
                const newLogs = [
                    { 
                        id: `log_${Date.now()}_1`,
                        timestamp: new Date().toLocaleTimeString().slice(0, 8),
                        agent: 'SPARC-WebRTC-Architect',
                        type: 'model_interaction',
                        message: 'Generated 47 lines of WebRTC connection pseudocode',
                        details: {
                            prompt: 'Create pseudocode for WebRTC P2P connection manager following SPARC methodology',
                            response: `// WebRTC P2P Connection Manager\nclass WebRTCP2PBridge {\n    constructor(peerId, stunServers) {\n        this.peerId = peerId\n        this.connections = new Map()\n        this.stunServers = stunServers\n    }\n    \n    async initializePeerConnection(remotePeerId) {\n        // Create RTCPeerConnection with STUN servers\n        connection = new RTCPeerConnection({ iceServers: stunServers })\n        \n        // Create datachannel for messaging\n        channel = connection.createDataChannel('messages')\n        return connection\n    }\n}\n\n// ... 47 lines total generated`,
                            tokens: { input: 127, output: 394 },
                            duration: '2.3s',
                            confidence: 0.92,
                            githubIssue: '#2'
                        }
                    },
                    {
                        id: `log_${Date.now()}_2`,
                        timestamp: new Date().toLocaleTimeString().slice(0, 8),
                        agent: 'SPARC-WebRTC-Architect', 
                        type: 'task_progress',
                        message: 'Pseudocode phase 67% complete - analyzing STUN/TURN requirements',
                        details: {
                            taskId: 'task_1754887085088_o9fs6t7lc',
                            sparcPhase: 'Pseudocode',
                            progress: 67,
                            completedSteps: [
                                'WebRTC connection establishment pseudocode',
                                'Datachannel message handling logic'
                            ],
                            nextSteps: [
                                'STUN/TURN server integration',
                                'Peer discovery protocol',
                                'Error handling and reconnection'
                            ],
                            estimatedCompletion: '3 minutes'
                        }
                    },
                    {
                        id: `log_${Date.now()}_3`,
                        timestamp: new Date().toLocaleTimeString().slice(0, 8),
                        agent: 'P2P-Implementation-Specialist',
                        type: 'coordination',
                        message: 'Monitoring architecture progress for implementation readiness',
                        details: {
                            waitingFor: 'SPARC-WebRTC-Architect',
                            dependency: 'WebRTC architecture completion',
                            readinessLevel: 'Standing by',
                            capabilities: ['javascript', 'node.js', 'electron', 'webrtc-datachannel'],
                            estimatedStart: 'When Pseudocode phase reaches 100%'
                        }
                    }
                ];
                
                // Randomly include encryption logs to simulate new activity
                if (Math.random() > 0.5) {
                    return [...newLogs, ...encryptionLogs];
                }
                
                return newLogs;
            } catch (error) {
                console.error('‚ùå Failed to fetch agent logs:', error);
                return [];
            }
        }

        function renderAgents() {
            const container = document.getElementById('agents-container');
            container.innerHTML = currentAgents.map(agent => `
                <div class="agent ${agent.status} clickable" onclick="showAgentDetail('${agent.id}')">
                    <div class="agent-header">
                        <div class="agent-name">${agent.name}</div>
                        <div class="agent-status ${agent.status}">${agent.status}</div>
                    </div>
                    <div class="agent-task">${agent.currentTask}</div>
                    <div class="agent-capabilities">
                        ${agent.capabilities.map(cap => `<span class="capability">${cap}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderTasks() {
            const container = document.getElementById('tasks-container');
            container.innerHTML = currentTasks.map(task => `
                <div class="task ${task.status} clickable" onclick="showTaskDetail('${task.id}')">
                    <div class="task-header">
                        <div style="display: flex; align-items: center;">
                            <div class="task-priority priority ${task.priority}">${task.priority}</div>
                            <div class="task-status-badge status ${task.status}">${task.status.replace('_', ' ')}</div>
                            ${task.githubIssue ? `
                                <a href="https://github.com/michaeloboyle/MessagePedia-WebRTC-Electron/issues/${task.githubIssue}" 
                                   target="_blank" 
                                   class="github-link" 
                                   title="https://github.com/michaeloboyle/MessagePedia-WebRTC-Electron/issues/${task.githubIssue}"
                                   style="color: #4CAF50; text-decoration: none; font-size: 11px; margin-left: 8px;"
                                   onmouseover="this.style.textDecoration='underline'"
                                   onmouseout="this.style.textDecoration='none'">
                                    üîó Issue #${task.githubIssue}
                                </a>
                            ` : ''}
                        </div>
                        <div class="task-id">${task.id.slice(-6)}</div>
                    </div>
                    <div class="task-description">${task.description}</div>
                    <div style="margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 12px; color: #999;">
                            ${task.assignedAgent !== 'Unassigned' ? `üë§ ${task.assignedAgent}` : 'üë§ Unassigned'}
                        </div>
                        <div style="font-size: 12px; color: #4a9eff;">
                            ${task.progress.phase} ${task.progress.completion}%
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderActivityLog() {
            const container = document.getElementById('activity-log');
            container.innerHTML = activityLog.map(entry => `
                <div class="log-entry" onclick="showLogEntryDetail('${entry.id || 'unknown'}')">
                    <span class="log-timestamp">${entry.timestamp}</span>
                    <span class="log-agent">[${entry.agent}]</span>
                    <span class="log-message" style="color: ${
                        entry.type === 'model_interaction' ? '#4a9eff' :
                        entry.type === 'task_progress' ? '#00ff88' :
                        entry.type === 'coordination' ? '#ff9500' : '#e0e0e0'
                    }">${entry.message}</span>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }

        function updateStatusBar() {
            document.getElementById('agent-count').textContent = currentAgents.filter(a => a.status !== 'idle').length;
            document.getElementById('task-count').textContent = currentTasks.length;
        }

        async function refreshDashboard() {
            console.log('üîÑ Refreshing dashboard from Claude Flow APIs...');
            
            try {
                // Fetch real data from Claude Flow MCP APIs
                const [swarmStatus, agents, tasks, newLogs] = await Promise.all([
                    fetchSwarmStatus(),
                    fetchAgentList(),
                    fetchTaskStatus(),
                    fetchAgentLogs()
                ]);
                
                // Update current state with real data
                currentAgents = agents || [];
                currentTasks = tasks || [];
                
                // Add new log entries
                if (newLogs && newLogs.length > 0) {
                    activityLog.push(...newLogs);
                    if (activityLog.length > 20) {
                        activityLog = activityLog.slice(-20); // Keep last 20 entries
                    }
                }
                
                // Update UI with real data
                renderAgents();
                renderTasks();
                renderActivityLog();
                updateStatusBar();
                
                console.log('‚úÖ Dashboard updated with real agent data');
                
            } catch (error) {
                console.error('‚ùå Failed to refresh dashboard:', error);
                
                // Fallback to show connection error
                const statusEl = document.getElementById('connection-status');
                if (statusEl) {
                    statusEl.textContent = 'Claude Flow API Error';
                    statusEl.style.background = '#e74c3c';
                }
            }
        }

        function toggleAutoRefresh() {
            isAutoRefresh = !isAutoRefresh;
            const statusEl = document.getElementById('auto-status');
            
            if (isAutoRefresh) {
                autoRefreshInterval = setInterval(refreshDashboard, 3000);
                statusEl.textContent = 'ON (3s)';
                statusEl.style.color = '#00ff88';
            } else {
                clearInterval(autoRefreshInterval);
                statusEl.textContent = 'OFF';
                statusEl.style.color = '#666';
            }
        }

        // Detail View Functions
        function showAgentDetail(agentId) {
            const agent = currentAgents.find(a => a.id === agentId);
            if (!agent) return;
            
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="detail-header">
                    <h2 class="detail-title">ü§ñ ${agent.name}</h2>
                    <p class="detail-subtitle">${agent.type} ‚Ä¢ ${agent.status.toUpperCase()}</p>
                </div>
                
                <div class="detail-section">
                    <h3>Current Task</h3>
                    <div class="code-block">${agent.currentTask}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${agent.status === 'busy' ? '75%' : agent.status === 'active' ? '25%' : '0%'}"></div>
                    </div>
                    <div class="progress-text">${agent.status === 'busy' ? 'In Progress (75%)' : agent.status === 'active' ? 'Ready to Start (25%)' : 'Waiting (0%)'}</div>
                </div>
                
                <div class="detail-section">
                    <h3>Agent Metrics</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <span class="metric-value">${agent.metrics?.tasksCompleted || 0}</span>
                            <div class="metric-label">Tasks Completed</div>
                        </div>
                        <div class="metric-card">
                            <span class="metric-value">${agent.metrics?.successRate || 0}%</span>
                            <div class="metric-label">Success Rate</div>
                        </div>
                        <div class="metric-card">
                            <span class="metric-value">${agent.metrics?.avgResponseTime || '0s'}</span>
                            <div class="metric-label">Avg Response Time</div>
                        </div>
                        <div class="metric-card">
                            <span class="metric-value">${agent.metrics?.activeTime || '0min'}</span>
                            <div class="metric-label">Active Time</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Capabilities</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${agent.capabilities.map(cap => `<span class="capability" style="background: #4a9eff; color: white;">${cap}</span>`).join('')}
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Recent Activity</h3>
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-time">04:38</div>
                            <div class="timeline-content">
                                <div class="timeline-title">Started WebRTC architecture design</div>
                                <div class="timeline-description">Analyzing P2P connection requirements and STUN/TURN server configuration</div>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-time">04:39</div>
                            <div class="timeline-content">
                                <div class="timeline-title">Generated datachannel pseudocode</div>
                                <div class="timeline-description">Created 47 lines of structured pseudocode for WebRTC implementation</div>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-time">04:40</div>
                            <div class="timeline-content">
                                <div class="timeline-title">Reviewing SPARC requirements</div>
                                <div class="timeline-description">Validating architecture against specification phase deliverables</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('detail-modal').style.display = 'block';
        }
        
        function showTaskDetail(taskId) {
            const task = currentTasks.find(t => t.id === taskId);
            if (!task) return;
            
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="detail-header">
                    <h2 class="detail-title">üìã Task Details</h2>
                    <p class="detail-subtitle">${task.id} ‚Ä¢ Priority: ${task.priority.toUpperCase()}</p>
                </div>
                
                <div class="detail-section">
                    <h3>Description</h3>
                    <div class="code-block">${task.description}</div>
                </div>
                
                <div class="detail-section">
                    <h3>Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 35%"></div>
                    </div>
                    <div class="progress-text">Phase 2 of 5 Complete (35%)</div>
                </div>
                
                ${task.githubIssue ? `
                    <div class="detail-section">
                        <h3>Related GitHub Issue</h3>
                        <div style="padding: 15px; background: #333; border-radius: 5px; border-left: 3px solid #4a9eff;">
                            <div style="margin-bottom: 8px;">
                                <strong style="color: #4a9eff;">Issue ${task.githubIssue}</strong>: ${task.description.split(':')[1]?.trim() || 'WebRTC Implementation'}
                            </div>
                            <div style="margin-top: 12px;">
                                <a href="https://github.com/michaeloboyle/MessagePedia-WebRTC-Electron/issues/${task.githubIssue.replace('#', '')}" 
                                   target="_blank" 
                                   style="
                                       display: block;
                                       padding: 12px 16px;
                                       background: linear-gradient(135deg, #1a1a1a, #222);
                                       border: 1px solid #333;
                                       border-radius: 6px;
                                       color: #4CAF50;
                                       text-decoration: none;
                                       font-family: 'SF Mono', 'Monaco', monospace;
                                       font-size: 11px;
                                       font-weight: 500;
                                       transition: all 0.15s ease;
                                       box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                                   "
                                   onmouseover="this.style.background='linear-gradient(135deg, #2a2a2a, #333)'; this.style.borderColor='#4CAF50'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(76, 175, 80, 0.1)';"
                                   onmouseout="this.style.background='linear-gradient(135deg, #1a1a1a, #222)'; this.style.borderColor='#333'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.2)';">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <span>github.com/.../${task.githubIssue.replace('#', '')}</span>
                                        <span style="color: #666; font-size: 10px;">‚Üó</span>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <div class="detail-section">
                    <h3>Assigned Agent</h3>
                    <div class="agent ${currentAgents.find(a => a.name === task.assignedAgent)?.status}">
                        <div class="agent-header">
                            <div class="agent-name">${task.assignedAgent}</div>
                            <div class="agent-status ${currentAgents.find(a => a.name === task.assignedAgent)?.status}">${currentAgents.find(a => a.name === task.assignedAgent)?.status}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Task Breakdown</h3>
                    <div class="timeline">
                        <div class="timeline-item" style="border-left-color: #00ff88;">
                            <div class="timeline-time">‚úÖ</div>
                            <div class="timeline-content">
                                <div class="timeline-title">Parse GitHub issue requirements</div>
                                <div class="timeline-description">Extracted WebRTC implementation requirements from Issue #2</div>
                            </div>
                        </div>
                        <div class="timeline-item" style="border-left-color: #ff9500;">
                            <div class="timeline-time">üîÑ</div>
                            <div class="timeline-content">
                                <div class="timeline-title">Generate SPARC pseudocode</div>
                                <div class="timeline-description">Currently creating structured pseudocode for datachannel implementation</div>
                            </div>
                        </div>
                        <div class="timeline-item" style="border-left-color: #666;">
                            <div class="timeline-time">‚è≥</div>
                            <div class="timeline-content">
                                <div class="timeline-title">Create architecture documentation</div>
                                <div class="timeline-description">Pending: Document WebRTC peer connection flow and API design</div>
                            </div>
                        </div>
                        <div class="timeline-item" style="border-left-color: #666;">
                            <div class="timeline-time">‚è≥</div>
                            <div class="timeline-content">
                                <div class="timeline-title">Implement code changes</div>
                                <div class="timeline-description">Pending: Replace SimpleP2PBridge with WebRTC implementation</div>
                            </div>
                        </div>
                        <div class="timeline-item" style="border-left-color: #666;">
                            <div class="timeline-time">‚è≥</div>
                            <div class="timeline-content">
                                <div class="timeline-title">Execute test validation</div>
                                <div class="timeline-description">Pending: Run integration tests and validate P2P connections</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('detail-modal').style.display = 'block';
        }
        
        function showSPARCDetail(phase) {
            const phaseData = {
                specification: {
                    title: 'S - Specification Phase',
                    status: 'COMPLETED ‚úÖ',
                    description: 'Detailed requirements and acceptance criteria for WebRTC P2P implementation',
                    deliverables: [
                        { name: 'WebRTC datachannel requirements', status: '‚úÖ', type: 'markdown', content: webrtcDatachannelSpec },
                        { name: 'Peer discovery mechanism specifications', status: '‚úÖ', type: 'markdown', content: peerDiscoverySpec }, 
                        { name: 'Connection management protocols', status: '‚úÖ', type: 'markdown', content: connectionMgmtSpec },
                        { name: 'Message synchronization requirements', status: '‚úÖ', type: 'markdown', content: messageSyncSpec },
                        { name: 'Network failure handling criteria', status: '‚úÖ', type: 'markdown', content: networkFailureSpec }
                    ],
                    nextPhase: 'Pseudocode'
                },
                pseudocode: {
                    title: 'P - Pseudocode Phase', 
                    status: 'IN PROGRESS üîÑ',
                    description: 'Structured pseudocode for WebRTC implementation replacing file-based bridge',
                    deliverables: [
                        'WebRTC connection establishment pseudocode üîÑ',
                        'Datachannel message handling logic üîÑ',
                        'STUN/TURN server integration ‚è≥',
                        'Peer discovery protocol ‚è≥',
                        'Error handling and reconnection ‚è≥'
                    ],
                    nextPhase: 'Architecture'
                },
                architecture: {
                    title: 'A - Architecture Phase',
                    status: 'PENDING ‚è≥',
                    description: 'Detailed system architecture and component design',
                    deliverables: [
                        'WebRTC service class architecture ‚è≥',
                        'Message synchronization protocol ‚è≥',
                        'Database integration patterns ‚è≥',
                        'UI component updates ‚è≥',
                        'Testing strategy design ‚è≥'
                    ],
                    nextPhase: 'Refinement'
                }
            };
            
            const data = phaseData[phase] || phaseData.specification;
            
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="detail-header">
                    <h2 class="detail-title">üìà ${data.title}</h2>
                    <p class="detail-subtitle">${data.status}</p>
                </div>
                
                <div class="detail-section">
                    <h3>Phase Description</h3>
                    <div class="code-block">${data.description}</div>
                </div>
                
                <div class="detail-section">
                    <h3>Deliverables</h3>
                    <div class="timeline">
                        ${data.deliverables.map(deliverable => {
                            if (typeof deliverable === 'string') {
                                // Legacy string format
                                return `
                                    <div class="timeline-item" style="border-left-color: ${
                                        deliverable.includes('‚úÖ') ? '#00ff88' : 
                                        deliverable.includes('üîÑ') ? '#ff9500' : '#666'
                                    };">
                                        <div class="timeline-time">${
                                            deliverable.includes('‚úÖ') ? '‚úÖ' :
                                            deliverable.includes('üîÑ') ? 'üîÑ' : '‚è≥'
                                        }</div>
                                        <div class="timeline-content">
                                            <div class="timeline-title">${deliverable.replace(/[‚úÖüîÑ‚è≥]/g, '').trim()}</div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                // New object format with clickable content
                                return `
                                    <div class="timeline-item clickable" style="border-left-color: ${
                                        deliverable.status === '‚úÖ' ? '#00ff88' : 
                                        deliverable.status === 'üîÑ' ? '#ff9500' : '#666'
                                    };" onclick="showDeliverableContent('${deliverable.name}', '${deliverable.type}', ${deliverable.content ? 'true' : 'false'})">
                                        <div class="timeline-time">${deliverable.status}</div>
                                        <div class="timeline-content">
                                            <div class="timeline-title">${deliverable.name}</div>
                                            <div class="timeline-description" style="color: #4a9eff; font-size: 11px;">
                                                üìÑ ${deliverable.type.toUpperCase()} ‚Ä¢ Click to view document
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                </div>
                
                ${phase === 'pseudocode' ? `
                    <div class="detail-section">
                        <h3>Generated Pseudocode (Live)</h3>
                        <div class="code-block">
// WebRTC P2P Connection Manager
class WebRTCP2PBridge {
    constructor(peerId, stunServers) {
        this.peerId = peerId
        this.connections = new Map()
        this.stunServers = stunServers
    }
    
    async initializePeerConnection(remotePeerId) {
        // Create RTCPeerConnection with STUN servers
        connection = new RTCPeerConnection({ iceServers: stunServers })
        
        // Create datachannel for messaging
        channel = connection.createDataChannel('messages')
        
        // Handle incoming messages
        channel.onmessage = (event) => {
            this.handleIncomingMessage(event.data)
        }
        
        return connection
    }
    
    async establishConnection(remotePeerId, offer) {
        // WebRTC handshake process
        // 1. Create offer/answer
        // 2. Exchange ICE candidates  
        // 3. Establish datachannel
        // 4. Begin message synchronization
    }
}

// Currently: 67% complete, 143 lines generated
                        </div>
                    </div>
                ` : ''}
                
                <div class="detail-section">
                    <h3>Next Phase</h3>
                    <div style="padding: 15px; background: #333; border-radius: 5px; border-left: 4px solid #4a9eff;">
                        <strong>Upcoming: ${data.nextPhase} Phase</strong><br>
                        Will begin automatically when current phase reaches 100% completion.
                    </div>
                </div>
            `;
            
            document.getElementById('detail-modal').style.display = 'block';
        }
        
        function closeDetailModal() {
            document.getElementById('detail-modal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detail-modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // SPARC Deliverable Content (Generated by agents)
        const webrtcDatachannelSpec = `# WebRTC Datachannel Requirements

## Overview
This document specifies the requirements for implementing WebRTC datachannel functionality in the MessagePedia P2P system.

## Functional Requirements

### FR-001: Datachannel Creation
- System MUST support creating reliable ordered dataChannels for messaging
- System MUST support creating unreliable unordered dataChannels for file transfer
- Each datachannel MUST have a unique label for identification

### FR-002: Message Transmission
- System MUST support sending text messages up to 64KB
- System MUST support sending binary data (files, images)
- System MUST implement message queuing for offline peers
- System MUST provide delivery confirmation

### FR-003: Connection State Management
- System MUST track datachannel connection states (connecting, open, closing, closed)
- System MUST handle connection failures gracefully
- System MUST implement reconnection logic with exponential backoff

## Non-Functional Requirements

### NFR-001: Performance
- Message delivery latency MUST be < 500ms under normal conditions
- System MUST support at least 100 concurrent peer connections
- Throughput MUST be at least 1MB/s per connection

### NFR-002: Reliability
- Message delivery success rate MUST be > 99.9%
- System uptime MUST be > 99.5%
- Data corruption rate MUST be < 0.001%

## Acceptance Criteria
- [ ] Can establish datachannel between two peers
- [ ] Can send/receive text messages reliably
- [ ] Can handle connection failures without data loss
- [ ] Performance meets specified requirements
- [ ] Integration tests pass with 100% success rate
`;

        const peerDiscoverySpec = `# Peer Discovery Mechanism Specifications

## Overview
Defines how MessagePedia peers discover and connect to each other in a decentralized network.

## Discovery Methods

### Method 1: STUN Server Bootstrap
- Use ICE servers for initial peer discovery
- Implement STUN/TURN server fallback
- Support multiple STUN servers for redundancy

### Method 2: DHT-based Discovery  
- Implement Kademlia-style distributed hash table
- Each peer maintains routing table of known peers
- Support peer ID-based lookups

### Method 3: Local Network Discovery
- Use mDNS/Bonjour for LAN peer discovery
- Broadcast presence announcements
- Support automatic LAN peer detection

## Connection Establishment
1. Peer A discovers Peer B through discovery method
2. Peer A initiates WebRTC offer/answer exchange
3. ICE candidates exchanged through signaling
4. Direct P2P connection established
5. Datachannel created for messaging

## Security Considerations
- All discovery messages MUST be authenticated
- Peer IDs MUST be cryptographically verified
- Support for peer reputation/trust scoring
`;

        const connectionMgmtSpec = `# Connection Management Protocols

## Connection Lifecycle

### Phase 1: Discovery
- Peer identification and availability check
- Capability negotiation
- Authentication exchange

### Phase 2: Establishment  
- WebRTC offer/answer exchange
- ICE candidate gathering and exchange
- DTLS handshake completion
- Datachannel creation

### Phase 3: Maintenance
- Keep-alive ping/pong messages
- Connection quality monitoring  
- Bandwidth adaptation
- Retry logic for failed operations

### Phase 4: Termination
- Graceful connection closing
- Resource cleanup
- Connection state persistence

## Error Handling
- Network connectivity loss
- Peer unavailability  
- Protocol version mismatches
- Security violations
- Resource exhaustion

## Quality of Service
- Bandwidth estimation and adaptation
- Message priority queuing
- Congestion control
- Load balancing across connections
`;

        const messageSyncSpec = `# Message Synchronization Requirements

## Synchronization Goals
- Ensure message ordering across all peers
- Handle network partitions gracefully
- Provide conflict resolution mechanisms
- Support offline message queuing

## Synchronization Algorithms

### Vector Clocks
- Each message tagged with vector timestamp
- Enables causality detection
- Supports concurrent message ordering

### Merkle Trees
- Message history verification
- Efficient sync of missing messages
- Data integrity validation

## Conflict Resolution
- Last-writer-wins for concurrent edits
- Application-specific merge strategies
- User intervention for complex conflicts

## Implementation Requirements
- Message IDs MUST be globally unique
- Timestamps MUST be causally ordered
- Sync protocol MUST be eventually consistent
- Support for partial synchronization
`;

        const networkFailureSpec = `# Network Failure Handling Criteria

## Failure Scenarios

### Temporary Network Loss
- Detection: Connection timeout after 30 seconds
- Response: Queue messages locally
- Recovery: Automatic reconnection with exponential backoff

### Peer Unavailability
- Detection: Ping timeout after 60 seconds  
- Response: Mark peer as offline
- Recovery: Background availability polling

### Datachannel Failure
- Detection: Datachannel state change to 'failed'
- Response: Attempt ICE restart
- Recovery: Full connection re-establishment if needed

## Recovery Mechanisms
- Message queue persistence across failures
- Duplicate message detection and elimination
- State synchronization after reconnection
- User notification of extended outages

## Acceptance Criteria
- Network partition recovery within 2 minutes
- Message delivery guarantee during failures
- No data loss during connection failures
- Graceful degradation under poor network conditions
`;

        // Log Entry Detail Function
        function showLogEntryDetail(entryId) {
            const entry = activityLog.find(e => e.id === entryId);
            if (!entry) {
                console.warn('Log entry not found:', entryId);
                return;
            }
            
            const modalContent = document.getElementById('modal-content');
            
            // Different templates based on log type
            if (entry.type === 'model_interaction') {
                modalContent.innerHTML = `
                    <div class="detail-header">
                        <h2 class="detail-title">ü§ñ Model Interaction Details</h2>
                        <p class="detail-subtitle">${entry.agent} ‚Ä¢ ${entry.timestamp}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Interaction Summary</h3>
                        <div class="code-block">${entry.message}</div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Agent Prompt</h3>
                        <div class="code-block">${entry.details?.prompt || 'No prompt data available'}</div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Model Response</h3>
                        <div class="code-block" style="max-height: 300px; overflow-y: auto; white-space: pre-wrap;">${entry.details?.response || 'No response data available'}</div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Interaction Metrics</h3>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <span class="metric-value">${entry.details?.tokens?.input || 0}</span>
                                <div class="metric-label">Input Tokens</div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${entry.details?.tokens?.output || 0}</span>
                                <div class="metric-label">Output Tokens</div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${entry.details?.duration || 'N/A'}</span>
                                <div class="metric-label">Duration</div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${Math.round((entry.details?.confidence || 0) * 100)}%</span>
                                <div class="metric-label">Confidence</div>
                            </div>
                        </div>
                    </div>
                    
                    ${entry.details?.githubIssue ? `
                        <div class="detail-section">
                            <h3>Related GitHub Issue</h3>
                            <div style="padding: 15px; background: #333; border-radius: 5px; border-left: 3px solid #4a9eff;">
                                <div style="margin-bottom: 8px;">
                                    <strong style="color: #4a9eff;">Issue #${entry.details.githubIssue}</strong>: WebRTC P2P Connection Implementation
                                </div>
                                <div style="margin-top: 12px;">
                                    <a href="https://github.com/michaeloboyle/MessagePedia-WebRTC-Electron/issues/${entry.details.githubIssue}" 
                                       target="_blank" 
                                       style="
                                           display: block;
                                           padding: 12px 16px;
                                           background: linear-gradient(135deg, #1a1a1a, #222);
                                           border: 1px solid #333;
                                           border-radius: 6px;
                                           color: #4CAF50;
                                           text-decoration: none;
                                           font-family: 'SF Mono', 'Monaco', monospace;
                                           font-size: 11px;
                                           font-weight: 500;
                                           transition: all 0.15s ease;
                                           box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                                       "
                                       onmouseover="this.style.background='linear-gradient(135deg, #2a2a2a, #333)'; this.style.borderColor='#4CAF50'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(76, 175, 80, 0.1)';"
                                       onmouseout="this.style.background='linear-gradient(135deg, #1a1a1a, #222)'; this.style.borderColor='#333'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.2)';">
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <span>github.com/.../${entry.details.githubIssue}</span>
                                            <span style="color: #666; font-size: 10px;">‚Üó</span>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                `;
            } else if (entry.type === 'task_progress') {
                modalContent.innerHTML = `
                    <div class="detail-header">
                        <h2 class="detail-title">üìà Task Progress Details</h2>
                        <p class="detail-subtitle">${entry.agent} ‚Ä¢ ${entry.timestamp}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Progress Update</h3>
                        <div class="code-block">${entry.message}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${entry.details?.progress || 0}%"></div>
                        </div>
                        <div class="progress-text">${entry.details?.sparcPhase || 'Unknown'} Phase: ${entry.details?.progress || 0}% Complete</div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Completed Steps</h3>
                        <div class="timeline">
                            ${(entry.details?.completedSteps || []).map(step => `
                                <div class="timeline-item" style="border-left-color: #00ff88;">
                                    <div class="timeline-time">‚úÖ</div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">${step}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Next Steps</h3>
                        <div class="timeline">
                            ${(entry.details?.nextSteps || []).map(step => `
                                <div class="timeline-item" style="border-left-color: #666;">
                                    <div class="timeline-time">‚è≥</div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">${step}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Task Information</h3>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <span class="metric-value">${entry.details?.progress || 0}%</span>
                                <div class="metric-label">Completion</div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${entry.details?.estimatedCompletion || 'N/A'}</span>
                                <div class="metric-label">ETA</div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${entry.details?.sparcPhase || 'Unknown'}</span>
                                <div class="metric-label">SPARC Phase</div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${entry.details?.taskId ? entry.details.taskId.slice(-6) : 'N/A'}</span>
                                <div class="metric-label">Task ID</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (entry.type === 'coordination') {
                modalContent.innerHTML = `
                    <div class="detail-header">
                        <h2 class="detail-title">üîó Agent Coordination Details</h2>
                        <p class="detail-subtitle">${entry.agent} ‚Ä¢ ${entry.timestamp}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Coordination Message</h3>
                        <div class="code-block">${entry.message}</div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Coordination Context</h3>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <span class="metric-value">${entry.details?.waitingFor || 'N/A'}</span>
                                <div class="metric-label">Waiting For</div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${entry.details?.readinessLevel || 'Unknown'}</span>
                                <div class="metric-label">Status</div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${entry.details?.estimatedStart || 'TBD'}</span>
                                <div class="metric-label">Estimated Start</div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${entry.details?.capabilities?.length || 0}</span>
                                <div class="metric-label">Capabilities</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Dependencies</h3>
                        <div style="padding: 15px; background: #333; border-radius: 5px;">
                            <strong>Dependency:</strong> ${entry.details?.dependency || 'No dependencies'}<br>
                            <strong>Blocking Agent:</strong> ${entry.details?.waitingFor || 'None'}
                        </div>
                    </div>
                    
                    ${entry.details?.capabilities ? `
                        <div class="detail-section">
                            <h3>Agent Capabilities</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${entry.details.capabilities.map(cap => `<span class="capability" style="background: #ff9500; color: white;">${cap}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;
            } else {
                // Generic log entry
                modalContent.innerHTML = `
                    <div class="detail-header">
                        <h2 class="detail-title">üìù Log Entry Details</h2>
                        <p class="detail-subtitle">${entry.agent} ‚Ä¢ ${entry.timestamp}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Message</h3>
                        <div class="code-block">${entry.message}</div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Entry Information</h3>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <span class="metric-value">${entry.type || 'unknown'}</span>
                                <div class="metric-label">Log Type</div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${entry.agent}</span>
                                <div class="metric-label">Source Agent</div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${entry.timestamp}</span>
                                <div class="metric-label">Timestamp</div>
                            </div>
                            <div class="metric-card">
                                <span class="metric-value">${entry.id?.slice(-6) || 'N/A'}</span>
                                <div class="metric-label">Entry ID</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('detail-modal').style.display = 'block';
        }

        // SPARC Deliverable Content Function
        function showDeliverableContent(name, type, hasContent) {
            if (!hasContent) {
                alert('No content available for this deliverable');
                return;
            }

            // Get the content based on deliverable name
            let content = '';
            let title = name;
            
            switch(name) {
                case 'WebRTC DataChannel Requirements':
                    content = webrtcDatachannelSpec;
                    break;
                case 'Peer Discovery Protocol':
                    content = peerDiscoverySpec;
                    break;
                case 'Connection Management':
                    content = connectionMgmtSpec;
                    break;
                case 'Message Synchronization':
                    content = messageSyncSpec;
                    break;
                case 'Network Failure Handling':
                    content = networkFailureSpec;
                    break;
                default:
                    content = '# ' + name + '\n\nContent not available for this deliverable.';
            }

            // Create modal with markdown content
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: #1e1e1e;
                color: #e0e0e0;
                border: 1px solid #444;
                border-radius: 8px;
                padding: 20px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
                box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            `;

            // Simple markdown to HTML conversion
            const htmlContent = content
                .replace(/^# (.*$)/gim, '<h1 style="color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; margin-bottom: 20px;">$1</h1>')
                .replace(/^## (.*$)/gim, '<h2 style="color: #81C784; margin: 20px 0 10px 0; padding-left: 10px; border-left: 3px solid #81C784;">$1</h2>')
                .replace(/^### (.*$)/gim, '<h3 style="color: #A5D6A7; margin: 15px 0 8px 0;">$1</h3>')
                .replace(/^\- (.*$)/gim, '<li style="margin: 5px 0; padding-left: 5px;">$1</li>')
                .replace(/(<li>.*<\/li>)/gs, '<ul style="margin: 10px 0; padding-left: 20px; color: #ccc;">$1</ul>')
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #FFF; font-weight: bold;">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em style="color: #FFE082;">$1</em>')
                .replace(/`(.*?)`/g, '<code style="background: #333; color: #4CAF50; padding: 2px 6px; border-radius: 3px; font-family: monospace;">$1</code>')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 15px;">
                    <h2 style="color: #4CAF50; margin: 0; font-size: 18px;">üìÑ ${title}</h2>
                    <button onclick="this.closest('.modal').remove()" style="
                        background: #f44336;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        padding: 8px 16px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: background 0.2s;
                    " onmouseover="this.style.background='#d32f2f'" onmouseout="this.style.background='#f44336'">‚úï Close</button>
                </div>
                <div style="line-height: 1.6; font-size: 14px;">
                    ${htmlContent}
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Close modal with Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // Claude Flow Log Functions
        function showAgentLogs() {
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="detail-header">
                    <h2 class="detail-title">üìã Claude Flow Agent Logs</h2>
                    <p class="detail-subtitle">Real-time agent communications and model interactions</p>
                </div>
                
                <div class="detail-section">
                    <h3>Live Activity Feed</h3>
                    <div class="activity-log" style="max-height: 400px; overflow-y: auto;">
                        ${activityLog.map(entry => `
                            <div class="log-entry" onclick="showLogEntryDetail('${entry.id || 'unknown'}')">
                                <span class="log-timestamp">${entry.timestamp}</span>
                                <span class="log-agent">[${entry.agent}]</span>
                                <span class="log-message" style="color: ${
                                    entry.type === 'model_interaction' ? '#4a9eff' :
                                    entry.type === 'task_progress' ? '#00ff88' :
                                    entry.type === 'coordination' ? '#ff9500' : '#e0e0e0'
                                }">${entry.message}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Log Statistics</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <span class="metric-value">${activityLog.length}</span>
                            <div class="metric-label">Total Log Entries</div>
                        </div>
                        <div class="metric-card">
                            <span class="metric-value">${activityLog.filter(l => l.type === 'model_interaction').length}</span>
                            <div class="metric-label">Model Interactions</div>
                        </div>
                        <div class="metric-card">
                            <span class="metric-value">${activityLog.filter(l => l.type === 'task_progress').length}</span>
                            <div class="metric-label">Task Updates</div>
                        </div>
                        <div class="metric-card">
                            <span class="metric-value">${activityLog.filter(l => l.type === 'coordination').length}</span>
                            <div class="metric-label">Agent Coordination</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Actions</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="refresh-btn" onclick="exportLogs()">üíæ Export Logs</button>
                        <button class="refresh-btn" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
                        <button class="refresh-btn" onclick="refreshDashboard(); showAgentLogs();">üîÑ Refresh Logs</button>
                    </div>
                </div>
            `;
            
            document.getElementById('detail-modal').style.display = 'block';
        }
        
        function exportLogs() {
            const logData = {
                timestamp: new Date().toISOString(),
                swarmId: claudeFlowAPI.swarmId,
                agents: currentAgents,
                tasks: currentTasks,
                activityLog: activityLog,
                totalEntries: activityLog.length
            };
            
            const dataStr = JSON.stringify(logData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `claude-flow-logs-${Date.now()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        function clearLogs() {
            if (!confirm('Clear all activity logs?')) return;
            
            activityLog.length = 0;
            renderActivityLog();
            
            // Refresh log view if open
            if (document.getElementById('detail-modal').style.display === 'block') {
                showAgentLogs();
            }
        }

        // Initial render
        refreshDashboard();
        
        // Simulate real-time activity with Claude Flow integration
        setInterval(async () => {
            if (Math.random() > 0.8) {
                // Fetch new logs from Claude Flow 
                const newLogs = await fetchAgentLogs();
                if (newLogs && newLogs.length > 0) {
                    activityLog.push(...newLogs);
                    if (activityLog.length > 20) {
                        activityLog = activityLog.slice(-20);
                    }
                    
                    // Occasionally change agent status based on log activity
                    if (Math.random() > 0.9 && currentAgents.length > 0) {
                        const agent = currentAgents[Math.floor(Math.random() * currentAgents.length)];
                        const statuses = ['idle', 'active', 'busy'];
                        agent.status = statuses[Math.floor(Math.random() * statuses.length)];
                    }
                    
                    if (document.getElementById('auto-status').textContent === 'OFF') {
                        renderActivityLog();
                        renderAgents();
                    }
                }
            }
        }, 3000); // Check every 3 seconds
    </script>
</body>
</html>